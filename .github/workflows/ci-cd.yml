name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    env:
      SERVER_IP: ${{ secrets.SERVER_IP }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      DEPLOY_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
        
      - name: Debug - Create and verify page components
        run: |
          # Create pages directory
          mkdir -p src/pages
          
          # Create Index.tsx
          cat > src/pages/Index.tsx << 'EOL'
          import React from 'react';
          
          const Index = () => {
            return (
              <div className="container mx-auto px-4 py-8">
                <h1 className="text-4xl font-bold text-white mb-6">
                  Welcome to Career Voyage Deck
                </h1>
                <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                  <div className="bg-slate-800 rounded-lg p-6">
                    <h2 className="text-2xl font-semibold text-white mb-4">
                      Explore Your Career Journey
                    </h2>
                    <p className="text-slate-300">
                      Visualize and plan your professional growth with our interactive tools and resources.
                    </p>
                  </div>
                </div>
              </div>
            );
          };
          
          export default Index;
          EOL
          
          # Create Contact.tsx
          cat > src/pages/Contact.tsx << 'EOL'
          import React from 'react';
          import { toast } from '../components/ui/use-toast';
          
          const Contact = () => {
            const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
              e.preventDefault();
              try {
                toast({
                  title: "Message sent!",
                  description: "We'll get back to you as soon as possible.",
                });
              } catch (error) {
                toast({
                  title: "Error",
                  description: "Failed to send message. Please try again.",
                  variant: "destructive",
                });
              }
            };
          
            return (
              <div className="container mx-auto px-4 py-8">
                <h1 className="text-4xl font-bold text-white mb-6">Contact Us</h1>
                <div className="max-w-2xl mx-auto">
                  <form onSubmit={handleSubmit} className="space-y-6">
                    <div className="space-y-2">
                      <label htmlFor="name" className="text-white">Name</label>
                      <input
                        type="text"
                        id="name"
                        name="name"
                        required
                        className="w-full p-2 rounded-md bg-slate-800 text-white border border-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <div className="space-y-2">
                      <label htmlFor="email" className="text-white">Email</label>
                      <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        className="w-full p-2 rounded-md bg-slate-800 text-white border border-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <div className="space-y-2">
                      <label htmlFor="message" className="text-white">Message</label>
                      <textarea
                        id="message"
                        name="message"
                        required
                        rows={4}
                        className="w-full p-2 rounded-md bg-slate-800 text-white border border-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <button
                      type="submit"
                      className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors"
                    >
                      Send Message
                    </button>
                  </form>
                </div>
              </div>
            );
          };
          
          export default Contact;
          EOL
          
          # Verify file creation and structure
          echo "Checking file structure:"
          ls -la src/pages/
          
          echo "File contents of Index.tsx:"
          cat src/pages/Index.tsx
          
          echo "File contents of Contact.tsx:"
          cat src/pages/Contact.tsx

      - name: Build
        run: |
          npm run build
          ls -la dist/
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          if ! ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} 'echo "SSH connection successful"'; then
            echo "Failed to establish SSH connection"
            exit 1
          fi

      - name: Deploy
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          # Create deployment script
          cat << 'EOF' > deploy.sh
          #!/bin/bash
          set -e

          echo "Starting deployment process..."
          
          # Function to check if port 80 is in use
          check_port_80() {
            if sudo lsof -i :80 >/dev/null 2>&1; then
              echo "Port 80 is in use. Attempting to free it..."
              sudo lsof -t -i:80 | xargs -r sudo kill -9
              sleep 5
            fi
          }

          # Function to wait for container health
          wait_for_container() {
            local container_name=$1
            local max_attempts=30
            local attempt=1

            while [ $attempt -le $max_attempts ]; do
              if docker inspect --format='{{.State.Health.Status}}' $container_name 2>/dev/null | grep -q "healthy"; then
                echo "$container_name is healthy"
                return 0
              fi
              echo "Waiting for $container_name to be healthy (attempt $attempt/$max_attempts)..."
              sleep 10
              attempt=$((attempt + 1))
            done
            
            echo "$container_name failed to become healthy"
            docker logs $container_name
            return 1
          }

          cd /app

          # Backup current deployment
          if [ -d "dist" ]; then
            mv dist dist_backup
          fi

          # Clean up Docker resources
          echo "Cleaning up Docker resources..."
          docker-compose down -v || true
          docker system prune -af --volumes || true

          # Check and free port 80
          check_port_80

          # Start containers
          echo "Starting containers..."
          docker-compose up -d --build --force-recreate

          # Wait for web_app container to be healthy
          if ! wait_for_container "web_app"; then
            echo "Deployment failed - rolling back..."
            docker-compose down
            [ -d "dist_backup" ] && mv dist_backup dist
            exit 1
          fi

          # Cleanup backup if deployment successful
          [ -d "dist_backup" ] && rm -rf dist_backup

          echo "Deployment completed successfully"
          EOF

          # Copy deployment files
          echo "Copying deployment files..."
          scp -i ~/.ssh/deploy_key \
            docker-compose.yml Dockerfile nginx.conf .env deploy.sh \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/app/

          # Copy dist directory
          echo "Copying dist directory..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} 'mkdir -p /app/dist'
          scp -i ~/.ssh/deploy_key -r dist/* \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/app/dist/

          # Execute deployment
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} '
            cd /app && 
            chmod +x deploy.sh && 
            ./deploy.sh
          '

      - name: Send Deployment Status Email
        if: always()
        run: |
          if [ -n "$RESEND_API_KEY" ]; then
            DEPLOY_STATUS="${{ job.status }}"
            DEPLOY_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            curl -X POST \
              -H "Authorization: Bearer $RESEND_API_KEY" \
              -H "Content-Type: application/json" \
              https://api.resend.com/emails \
              -d '{
                "from": "notifications@hassan-adam.com",
                "to": "haskhr@hotmail.com",
                "subject": "Deployment Status: '"$DEPLOY_STATUS"'",
                "html": "
                  <h2>Deployment Status: '"$DEPLOY_STATUS"'</h2>
                  <p><strong>Repository:</strong> '"${{ github.repository }}"'</p>
                  <p><strong>Branch:</strong> '"${GITHUB_REF#refs/heads/}"'</p>
                  <p><strong>Commit:</strong> '"${{ github.sha }}"'</p>
                  <p><strong>Triggered by:</strong> '"${{ github.actor }}"'</p>
                  <p><strong>Deployment Time:</strong> '"$DEPLOY_TIME"'</p>
                "
              }'
          else
            echo "RESEND_API_KEY not set, skipping email notification"
          fi
          

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} '
            cd /app
            docker-compose down -v || true
            docker system prune -af || true
          ' || true
